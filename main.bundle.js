(()=>{"use strict";var t,e,n,s,i,r={},a=[],o=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i;function l(t,e){for(var n in e)t[n]=e[n];return t}function c(t){var e=t.parentNode;e&&e.removeChild(t)}function d(e,n,s){var i,r,a,o={};for(a in n)"key"==a?i=n[a]:"ref"==a?r=n[a]:o[a]=n[a];if(arguments.length>2&&(o.children=arguments.length>3?t.call(arguments,2):s),"function"==typeof e&&null!=e.defaultProps)for(a in e.defaultProps)void 0===o[a]&&(o[a]=e.defaultProps[a]);return h(e,o,i,r,null)}function h(t,s,i,r,a){var o={type:t,props:s,key:i,ref:r,__k:null,__:null,__b:0,__e:null,__d:void 0,__c:null,__h:null,constructor:void 0,__v:null==a?++n:a};return null==a&&null!=e.vnode&&e.vnode(o),o}function u(t){return t.children}function f(t,e){this.props=t,this.context=e}function p(t,e){if(null==e)return t.__?p(t.__,t.__.__k.indexOf(t)+1):null;for(var n;e<t.__k.length;e++)if(null!=(n=t.__k[e])&&null!=n.__e)return n.__e;return"function"==typeof t.type?p(t):null}function m(t){var e,n;if(null!=(t=t.__)&&null!=t.__c){for(t.__e=t.__c.base=null,e=0;e<t.__k.length;e++)if(null!=(n=t.__k[e])&&null!=n.__e){t.__e=t.__c.base=n.__e;break}return m(t)}}function _(t){(!t.__d&&(t.__d=!0)&&s.push(t)&&!g.__r++||i!==e.debounceRendering)&&((i=e.debounceRendering)||setTimeout)(g)}function g(){for(var t;g.__r=s.length;)t=s.sort((function(t,e){return t.__v.__b-e.__v.__b})),s=[],t.some((function(t){var e,n,s,i,r,a;t.__d&&(r=(i=(e=t).__v).__e,(a=e.__P)&&(n=[],(s=l({},i)).__v=i.__v+1,x(a,i,s,e.__n,void 0!==a.ownerSVGElement,null!=i.__h?[r]:null,n,null==r?p(i):r,i.__h),S(n,i),i.__e!=r&&m(i)))}))}function v(t,e,n,s,i,o,l,c,d,f){var m,_,g,v,y,E,b,T=s&&s.__k||a,S=T.length;for(n.__k=[],m=0;m<e.length;m++)if(null!=(v=n.__k[m]=null==(v=e[m])||"boolean"==typeof v?null:"string"==typeof v||"number"==typeof v||"bigint"==typeof v?h(null,v,null,null,v):Array.isArray(v)?h(u,{children:v},null,null,null):v.__b>0?h(v.type,v.props,v.key,v.ref?v.ref:null,v.__v):v)){if(v.__=n,v.__b=n.__b+1,null===(g=T[m])||g&&v.key==g.key&&v.type===g.type)T[m]=void 0;else for(_=0;_<S;_++){if((g=T[_])&&v.key==g.key&&v.type===g.type){T[_]=void 0;break}g=null}x(t,v,g=g||r,i,o,l,c,d,f),y=v.__e,(_=v.ref)&&g.ref!=_&&(b||(b=[]),g.ref&&b.push(g.ref,null,v),b.push(_,v.__c||y,v)),null!=y?(null==E&&(E=y),"function"==typeof v.type&&v.__k===g.__k?v.__d=d=k(v,d,t):d=w(t,v,g,T,y,d),"function"==typeof n.type&&(n.__d=d)):d&&g.__e==d&&d.parentNode!=t&&(d=p(g))}for(n.__e=E,m=S;m--;)null!=T[m]&&P(T[m],T[m]);if(b)for(m=0;m<b.length;m++)C(b[m],b[++m],b[++m])}function k(t,e,n){for(var s,i=t.__k,r=0;i&&r<i.length;r++)(s=i[r])&&(s.__=t,e="function"==typeof s.type?k(s,e,n):w(n,s,s,i,s.__e,e));return e}function w(t,e,n,s,i,r){var a,o,l;if(void 0!==e.__d)a=e.__d,e.__d=void 0;else if(null==n||i!=r||null==i.parentNode)t:if(null==r||r.parentNode!==t)t.appendChild(i),a=null;else{for(o=r,l=0;(o=o.nextSibling)&&l<s.length;l+=2)if(o==i)break t;t.insertBefore(i,r),a=r}return void 0!==a?a:i.nextSibling}function y(t,e,n){"-"===e[0]?t.setProperty(e,n):t[e]=null==n?"":"number"!=typeof n||o.test(e)?n:n+"px"}function E(t,e,n,s,i){var r;t:if("style"===e)if("string"==typeof n)t.style.cssText=n;else{if("string"==typeof s&&(t.style.cssText=s=""),s)for(e in s)n&&e in n||y(t.style,e,"");if(n)for(e in n)s&&n[e]===s[e]||y(t.style,e,n[e])}else if("o"===e[0]&&"n"===e[1])r=e!==(e=e.replace(/Capture$/,"")),e=e.toLowerCase()in t?e.toLowerCase().slice(2):e.slice(2),t.l||(t.l={}),t.l[e+r]=n,n?s||t.addEventListener(e,r?T:b,r):t.removeEventListener(e,r?T:b,r);else if("dangerouslySetInnerHTML"!==e){if(i)e=e.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if("href"!==e&&"list"!==e&&"form"!==e&&"tabIndex"!==e&&"download"!==e&&e in t)try{t[e]=null==n?"":n;break t}catch(t){}"function"==typeof n||(null==n||!1===n&&-1==e.indexOf("-")?t.removeAttribute(e):t.setAttribute(e,n))}}function b(t){this.l[t.type+!1](e.event?e.event(t):t)}function T(t){this.l[t.type+!0](e.event?e.event(t):t)}function x(t,n,s,i,r,a,o,c,d){var h,p,m,_,g,k,w,y,E,b,T,x,S,C,P,L=n.type;if(void 0!==n.constructor)return null;null!=s.__h&&(d=s.__h,c=n.__e=s.__e,n.__h=null,a=[c]),(h=e.__b)&&h(n);try{t:if("function"==typeof L){if(y=n.props,E=(h=L.contextType)&&i[h.__c],b=h?E?E.props.value:h.__:i,s.__c?w=(p=n.__c=s.__c).__=p.__E:("prototype"in L&&L.prototype.render?n.__c=p=new L(y,b):(n.__c=p=new f(y,b),p.constructor=L,p.render=R),E&&E.sub(p),p.props=y,p.state||(p.state={}),p.context=b,p.__n=i,m=p.__d=!0,p.__h=[],p._sb=[]),null==p.__s&&(p.__s=p.state),null!=L.getDerivedStateFromProps&&(p.__s==p.state&&(p.__s=l({},p.__s)),l(p.__s,L.getDerivedStateFromProps(y,p.__s))),_=p.props,g=p.state,m)null==L.getDerivedStateFromProps&&null!=p.componentWillMount&&p.componentWillMount(),null!=p.componentDidMount&&p.__h.push(p.componentDidMount);else{if(null==L.getDerivedStateFromProps&&y!==_&&null!=p.componentWillReceiveProps&&p.componentWillReceiveProps(y,b),!p.__e&&null!=p.shouldComponentUpdate&&!1===p.shouldComponentUpdate(y,p.__s,b)||n.__v===s.__v){for(p.props=y,p.state=p.__s,n.__v!==s.__v&&(p.__d=!1),p.__v=n,n.__e=s.__e,n.__k=s.__k,n.__k.forEach((function(t){t&&(t.__=n)})),T=0;T<p._sb.length;T++)p.__h.push(p._sb[T]);p._sb=[],p.__h.length&&o.push(p);break t}null!=p.componentWillUpdate&&p.componentWillUpdate(y,p.__s,b),null!=p.componentDidUpdate&&p.__h.push((function(){p.componentDidUpdate(_,g,k)}))}if(p.context=b,p.props=y,p.__v=n,p.__P=t,x=e.__r,S=0,"prototype"in L&&L.prototype.render){for(p.state=p.__s,p.__d=!1,x&&x(n),h=p.render(p.props,p.state,p.context),C=0;C<p._sb.length;C++)p.__h.push(p._sb[C]);p._sb=[]}else do{p.__d=!1,x&&x(n),h=p.render(p.props,p.state,p.context),p.state=p.__s}while(p.__d&&++S<25);p.state=p.__s,null!=p.getChildContext&&(i=l(l({},i),p.getChildContext())),m||null==p.getSnapshotBeforeUpdate||(k=p.getSnapshotBeforeUpdate(_,g)),P=null!=h&&h.type===u&&null==h.key?h.props.children:h,v(t,Array.isArray(P)?P:[P],n,s,i,r,a,o,c,d),p.base=n.__e,n.__h=null,p.__h.length&&o.push(p),w&&(p.__E=p.__=null),p.__e=!1}else null==a&&n.__v===s.__v?(n.__k=s.__k,n.__e=s.__e):n.__e=A(s.__e,n,s,i,r,a,o,d);(h=e.diffed)&&h(n)}catch(t){n.__v=null,(d||null!=a)&&(n.__e=c,n.__h=!!d,a[a.indexOf(c)]=null),e.__e(t,n,s)}}function S(t,n){e.__c&&e.__c(n,t),t.some((function(n){try{t=n.__h,n.__h=[],t.some((function(t){t.call(n)}))}catch(t){e.__e(t,n.__v)}}))}function A(e,n,s,i,a,o,l,d){var h,u,f,m=s.props,_=n.props,g=n.type,k=0;if("svg"===g&&(a=!0),null!=o)for(;k<o.length;k++)if((h=o[k])&&"setAttribute"in h==!!g&&(g?h.localName===g:3===h.nodeType)){e=h,o[k]=null;break}if(null==e){if(null===g)return document.createTextNode(_);e=a?document.createElementNS("http://www.w3.org/2000/svg",g):document.createElement(g,_.is&&_),o=null,d=!1}if(null===g)m===_||d&&e.data===_||(e.data=_);else{if(o=o&&t.call(e.childNodes),u=(m=s.props||r).dangerouslySetInnerHTML,f=_.dangerouslySetInnerHTML,!d){if(null!=o)for(m={},k=0;k<e.attributes.length;k++)m[e.attributes[k].name]=e.attributes[k].value;(f||u)&&(f&&(u&&f.__html==u.__html||f.__html===e.innerHTML)||(e.innerHTML=f&&f.__html||""))}if(function(t,e,n,s,i){var r;for(r in n)"children"===r||"key"===r||r in e||E(t,r,null,n[r],s);for(r in e)i&&"function"!=typeof e[r]||"children"===r||"key"===r||"value"===r||"checked"===r||n[r]===e[r]||E(t,r,e[r],n[r],s)}(e,_,m,a,d),f)n.__k=[];else if(k=n.props.children,v(e,Array.isArray(k)?k:[k],n,s,i,a&&"foreignObject"!==g,o,l,o?o[0]:s.__k&&p(s,0),d),null!=o)for(k=o.length;k--;)null!=o[k]&&c(o[k]);d||("value"in _&&void 0!==(k=_.value)&&(k!==e.value||"progress"===g&&!k||"option"===g&&k!==m.value)&&E(e,"value",k,m.value,!1),"checked"in _&&void 0!==(k=_.checked)&&k!==e.checked&&E(e,"checked",k,m.checked,!1))}return e}function C(t,n,s){try{"function"==typeof t?t(n):t.current=n}catch(t){e.__e(t,s)}}function P(t,n,s){var i,r;if(e.unmount&&e.unmount(t),(i=t.ref)&&(i.current&&i.current!==t.__e||C(i,null,n)),null!=(i=t.__c)){if(i.componentWillUnmount)try{i.componentWillUnmount()}catch(t){e.__e(t,n)}i.base=i.__P=null,t.__c=void 0}if(i=t.__k)for(r=0;r<i.length;r++)i[r]&&P(i[r],n,s||"function"!=typeof t.type);s||null==t.__e||c(t.__e),t.__=t.__e=t.__d=void 0}function R(t,e,n){return this.constructor(t,n)}function L(n,s,i){var a,o,l;e.__&&e.__(n,s),o=(a="function"==typeof i)?null:i&&i.__k||s.__k,l=[],x(s,n=(!a&&i||s).__k=d(u,null,[n]),o||r,r,void 0!==s.ownerSVGElement,!a&&i?[i]:o?null:s.firstChild?t.call(s.childNodes):null,l,!a&&i?i:o?o.__e:s.firstChild,a),S(l,n)}t=a.slice,e={__e:function(t,e,n,s){for(var i,r,a;e=e.__;)if((i=e.__c)&&!i.__)try{if((r=i.constructor)&&null!=r.getDerivedStateFromError&&(i.setState(r.getDerivedStateFromError(t)),a=i.__d),null!=i.componentDidCatch&&(i.componentDidCatch(t,s||{}),a=i.__d),a)return i.__E=i}catch(e){t=e}throw t}},n=0,f.prototype.setState=function(t,e){var n;n=null!=this.__s&&this.__s!==this.state?this.__s:this.__s=l({},this.state),"function"==typeof t&&(t=t(l({},n),this.props)),t&&l(n,t),null!=t&&this.__v&&(e&&this._sb.push(e),_(this))},f.prototype.forceUpdate=function(t){this.__v&&(this.__e=!0,t&&this.__h.push(t),_(this))},f.prototype.render=u,s=[],g.__r=0;const U=Symbol("Comlink.proxy"),I=Symbol("Comlink.endpoint"),F=Symbol("Comlink.releaseProxy"),M=Symbol("Comlink.thrown"),D=t=>"object"==typeof t&&null!==t||"function"==typeof t,O=new Map([["proxy",{canHandle:t=>D(t)&&t[U],serialize(t){const{port1:e,port2:n}=new MessageChannel;return B(t,e),[n,[n]]},deserialize:t=>(t.start(),V(t))}],["throw",{canHandle:t=>D(t)&&M in t,serialize({value:t}){let e;return e=t instanceof Error?{isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:{isError:!1,value:t},[e,[]]},deserialize(t){if(t.isError)throw Object.assign(new Error(t.value.message),t.value);throw t.value}}]]);function B(t,e=self){e.addEventListener("message",(function n(s){if(!s||!s.data)return;const{id:i,type:r,path:a}=Object.assign({path:[]},s.data),o=(s.data.argumentList||[]).map(K);let l;try{const e=a.slice(0,-1).reduce(((t,e)=>t[e]),t),n=a.reduce(((t,e)=>t[e]),t);switch(r){case"GET":l=n;break;case"SET":e[a.slice(-1)[0]]=K(s.data.value),l=!0;break;case"APPLY":l=n.apply(e,o);break;case"CONSTRUCT":l=G(new n(...o));break;case"ENDPOINT":{const{port1:e,port2:n}=new MessageChannel;B(t,n),l=function(t,e){return Y.set(t,e),t}(e,[e])}break;case"RELEASE":l=void 0;break;default:return}}catch(t){l={value:t,[M]:0}}Promise.resolve(l).catch((t=>({value:t,[M]:0}))).then((t=>{const[s,a]=j(t);e.postMessage(Object.assign(Object.assign({},s),{id:i}),a),"RELEASE"===r&&(e.removeEventListener("message",n),N(e))}))})),e.start&&e.start()}function N(t){(function(t){return"MessagePort"===t.constructor.name})(t)&&t.close()}function V(t,e){return X(t,[],e)}function H(t){if(t)throw new Error("Proxy has been released and is not useable")}function X(t,e=[],n=function(){}){let s=!1;const i=new Proxy(n,{get(n,r){if(H(s),r===F)return()=>$(t,{type:"RELEASE",path:e.map((t=>t.toString()))}).then((()=>{N(t),s=!0}));if("then"===r){if(0===e.length)return{then:()=>i};const n=$(t,{type:"GET",path:e.map((t=>t.toString()))}).then(K);return n.then.bind(n)}return X(t,[...e,r])},set(n,i,r){H(s);const[a,o]=j(r);return $(t,{type:"SET",path:[...e,i].map((t=>t.toString())),value:a},o).then(K)},apply(n,i,r){H(s);const a=e[e.length-1];if(a===I)return $(t,{type:"ENDPOINT"}).then(K);if("bind"===a)return X(t,e.slice(0,-1));const[o,l]=W(r);return $(t,{type:"APPLY",path:e.map((t=>t.toString())),argumentList:o},l).then(K)},construct(n,i){H(s);const[r,a]=W(i);return $(t,{type:"CONSTRUCT",path:e.map((t=>t.toString())),argumentList:r},a).then(K)}});return i}function W(t){const e=t.map(j);return[e.map((t=>t[0])),(n=e.map((t=>t[1])),Array.prototype.concat.apply([],n))];var n}const Y=new WeakMap;function G(t){return Object.assign(t,{[U]:!0})}function j(t){for(const[e,n]of O)if(n.canHandle(t)){const[s,i]=n.serialize(t);return[{type:"HANDLER",name:e,value:s},i]}return[{type:"RAW",value:t},Y.get(t)||[]]}function K(t){switch(t.type){case"HANDLER":return O.get(t.name).deserialize(t.value);case"RAW":return t.value}}function $(t,e,n){return new Promise((s=>{const i=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");t.addEventListener("message",(function e(n){n.data&&n.data.id&&n.data.id===i&&(t.removeEventListener("message",e),s(n.data))})),t.start&&t.start(),t.postMessage(Object.assign({id:i},e),n)}))}const z=function(t){return!0};async function q(t,e={}){const n=e.allowCache??!1,s=e.guard??z,i=await fetch(t,{method:"GET",cache:n?"default":"no-store"});if(!i.ok)return Promise.reject(new Error(`Request failed (${t})`));const r=await i.json();return s(r)?r:Promise.reject(new Error("Invalid data."))}const J="https:"===window.location.protocol,Z={server:{wss:J,host:"127.0.0.1",port:J?8443:8080}},Q=q("client-config.json",{guard:function(t){if(!t||!t.server)return!1;const e=t.server;return void 0!==e.wss&&e.host&&e.port}}).then((t=>{if(J&&!t.server.wss)throw new Error("Cannot use insecure websocket connection.");return t}),(t=>(console.error("Loading client config failed: "+t),Z))),tt=new Intl.NumberFormat("en-US",{maximumSignificantDigits:2});class et{x;y;constructor(t,e){this.x=t,this.y=e}static fromObject(t){return new et(t.x,t.y)}static distance(t,e){const n=t.x-e.x,s=t.y-e.y;return Math.sqrt(n*n+s*s)}static lerp(t,e,n){const s=1-n;return new et(s*t.x+n*e.x,s*t.y+n*e.y)}static equals(t,e,n){const s=t.x-e.x,i=t.y-e.y;return s*s+i*i<n*n}addPolar(t,e){this.x+=e*Math.cos(t),this.y+=e*Math.sin(t)}createTransferable(){return this}set(t){this.x=t.x,this.y=t.y}clone(){return new et(this.x,this.y)}toString(){const t=tt.format;return`<${t(this.x)},${t(this.y)}>`}}class nt{data;constructor(t){if(this.data=new Float32Array(9),t)for(let t=0;t<3;t++)this.data[4*t]=1}setEntry(t,e,n){this.data[t+3*e]=n}getEntry(t,e){return this.data[t+3*e]}multiply(t,e=new et(0,0)){const n=this.data;return e.x=n[0]*t.x+n[3]*t.y+n[6],e.y=n[1]*t.x+n[4]*t.y+n[7],e}static compose(t,e,n){void 0===n&&(n=new nt(!1));for(let s=0;s<3;s++)for(let i=0;i<3;i++){let r=0;for(let n=0;n<3;n++)r+=t.data[s+3*n]*e.data[n+3*i];n.data[s+3*i]=r}return n}}class st{minX;maxX;minY;maxY;constructor(t,e,n,s){this.minX=t,this.maxX=e,this.minY=n,this.maxY=s}static fromTransferable(t){return new st(t.minX,t.maxX,t.minY,t.maxY)}static createAt(t,e,n){const s=.5*e,i=.5*n;return new st(t.x-s,t.x+s,t.y-i,t.y+i)}static distance2(t,e){let n=0,s=0;return t.maxX<e.minX?n=e.minX-t.maxX:e.maxX<t.minX&&(n=t.minX-e.maxX),t.maxY<e.minY?s=e.minY-t.maxY:e.maxY<t.minY&&(s=t.minY-e.maxY),n*n+s*s}get width(){return this.maxX-this.minX}get height(){return this.maxY-this.minY}createTransferable(t=0){return{minX:this.minX-t,maxX:this.maxX+t,minY:this.minY-t,maxY:this.maxY+t}}extendTo(t,e=Number.EPSILON){return new st(Math.min(this.minX,t.x-e),Math.max(this.maxX,t.x+e),Math.min(this.minY,t.y-e),Math.max(this.maxY,t.y+e))}contains(t){const e=this.minX<=t.x&&t.x<this.maxX,n=this.minY<=t.y&&t.y<this.maxY;return e&&n}}const it=.042,rt=new nt(!0);rt.setEntry(0,0,it),rt.setEntry(1,1,it);class at{#t=new et(0,0);#e=new nt(!0);#n=new nt(!0);#s=null;setRatio(t,e){this.#e.setEntry(0,0,e/t)}moveToSnake(t){this.moveTo(t.position)}moveTo(t){this.#t.set(t),this.#s=null}computeScreenCoordinates(t,e){const n=e.clientWidth,s=e.clientHeight,i=this.transformMatrix.multiply(t);return i.y*=-1,i.x+=1,i.x=.5*n*i.x,i.y+=1,i.y=.5*s*i.y,i}get position(){return this.#t}get transformMatrix(){if(null===this.#s){const t=this.#t;this.#n.setEntry(0,2,-t.x),this.#n.setEntry(1,2,-t.y),this.#s=nt.compose(nt.compose(this.#e,rt),this.#n)}return this.#s}get viewBox(){const t=this.#t,e=2/(this.#e.getEntry(0,0)*it),n=2/it;return new st(t.x-.5*e,t.x+.5*e,t.y-.5*n,t.y+.5*n)}}let ot=0;function lt(){return ot}function ct(t=performance.now()){ot=t}function dt(t){if(!Number.isFinite(t))return 0;for(;Math.abs(t)>Math.PI;)t-=2*Math.sign(t)*Math.PI;return t}const ht=2*Math.PI;function ut(t,e){const n=e-t,s=n-Math.sign(n)*ht;return Math.abs(s)<Math.abs(n)?s:n}function ft(t,e,n){return Math.max(t,Math.min(e,n))}const pt=65535;class mt{id;skin;headChunk=null;#i;#r=[];#a=new Set;#o;#l;#c;#d;#h;#u;#f;#p;#m=!1;#_;#g;#v;#k;#w;constructor(t,e){this.id=t.id,this.skin=t.skin,this.#i=e,this.#l=lt(),this.#g=et.fromObject(t.headPosition),this.#k=t.headDirection[0],this.#u=t.fast?1:0,this.update(t,0)}update(t,e){this.#o=lt(),this.#d=t.length,this.#c=t.headChunkId,this.#_=et.fromObject(t.headPosition),this.#v=t.headDirection[0],this.#w=t.headDirection[1],this.#h=t.fast,this.#f=t.width,t.name&&(this.#p=t.name),this.#m&&(this.#g=et.fromObject(t.headPosition),this.#k=t.headDirection[0],this.#l=lt(),this.#m=!1),this.#y(e,t.fastHistory)}predict(){this.#E(),this.#b();for(const t of this.#r)t.predict();this.headChunk&&this.headChunk.connectMeshToHead(),this.#T(),this.#l=lt()}registerSnakeChunk(t){if(this.#a.has(t.id))return;if(this.#a.add(t.id),t.id===this.#c)return this.#r.push(t),null!==this.headChunk&&this.headChunk.resetMesh(),void(this.headChunk=t);if(0===this.#r.length)return void this.#r.push(t);const e=pt-(this.#c&pt),n=_t(t,e);let s=this.#r.length-1;for(;0<=s&&!(_t(this.#r[s],e)<n);s--);this.#r.splice(s+1,0,t)}unregisterSnakeChunk(t){const e=this.#r.findIndex((e=>e===t));if(e<0)throw new Error(`Cannot unregister: Snake ${this.id} has no chunk with id ${t.id}.`);this.#a.delete(t.id),this.#r.splice(e,1)}getSnakeChunksIterator(){return this.#r.values()}hasChunks(){return this.#r.length>0}toString(){return`Snake ${this.id} with ${this.#r.length} chunks`}couldBeVisible(t,e=0){for(const n of this.#r)if(n.couldBeVisible(t,e))return!0;return this.isHeadVisible(t,e)}isHeadVisible(t,e=0){const n=5*this.#f,s=st.createAt(this.#g,n,n);return st.distance2(s,t.viewBox)<=e*e}destroy(){}pause(){this.#m=!0}get name(){return this.#p}get fast(){return this.#h}get smoothedFastValue(){return this.#u}get length(){return this.#d}get speed(){if(this.#m)return 0;const t=this.#i;return(this.#h?t.snakes.fastSpeed:t.snakes.speed)/t.tickDuration}get position(){return this.#g}get direction(){return this.#k}get width(){return this.#f}#E(){const t=this.speed,e=lt(),n=t*(e-this.#l)/1e3,s=t*(e-this.#o)/1e3;this.#g.addPolar(this.#k,n);const i=this.#_.clone();i.addPolar(this.#k,s),this.#g=et.lerp(this.#g,i,.15)}#b(){const t=lt(),e=this.#i.snakes.maxTurnDelta/this.#i.tickDuration,n=ut(this.#k,this.#w),s=ut(this.#v,this.#w),i=e*(t-this.#l)/1e3,r=e*(t-this.#o)/1e3,a=dt(this.#k+ft(-i,n,i)),o=dt(this.#v+ft(-r,s,r));this.#k=dt(a+.15*ut(a,o))}#T(){const t=(lt()-this.#l)/1e3,e=this.fast?1:0,n=ft(0,5*t,1);this.#u=n*e+(1-n)*this.#u}#y(t,e){if(0===t)return;const n=this.#i.snakes.fastSpeed,s=this.#i.snakes.speed;let i=0;const r=Math.min(t,e.length);for(let t=0;t<r;t++)i+=e[t]?n:s;for(let e=r;e<t;e++)i+=s;for(const t of this.#r)t.id!==this.#c&&t.updateOffset(i)}}function _t(t,e){return(t.id&pt)+e&pt}class gt{snake;id;gpuData;#x=!1;#S;#A=lt();#o;#d;#C;#l=lt();#P;#R;constructor(t,e){this.snake=t,this.id=e.id,t.registerSnakeChunk(this),this.update(e),this.#R=e.offset}update(t){if(this.#x=t.full,this.#S=st.fromTransferable(t.boundingBox),this.gpuData={buffer:t.data,vertices:t.vertices},this.#P=t.offset,0===this.#P){const e=t.length-this.#d;this.#R-=e}this.#d=t.length,this.#C=lt(),this.#o=lt()}updateOffset(t){this.#P+=t,this.#C=lt()}predict(){const t=this.snake.speed,e=lt(),n=t*(e-this.#l)/1e3,s=t*(e-this.#C)/1e3,i=this.#R+n,r=this.#P+s;this.#R=.85*i+.15*r,this.#l=lt()}connectMeshToHead(){const t=this.snake.position,e=this.gpuData.buffer;let n=6*(this.gpuData.vertices-2);e[n+0]=t.x,e[n+1]=t.y,e[n+5]=-this.#R,n+=6,e[n+0]=t.x,e[n+1]=t.y,e[n+5]=-this.#R}resetMesh(){const t=this.gpuData.buffer;let e=6*(this.gpuData.vertices-2),n=e-12;t[e+0]=t[n+0],t[e+1]=t[n+1],t[e+5]=t[n+5],e+=6,n+=6,t[e+0]=t[n+0],t[e+1]=t[n+1],t[e+5]=t[n+5]}couldBeVisible(t,e=0){const n=st.distance2(t.viewBox,this.#S),s=.5*this.snake.width+e;return n<=s*s}destroy(){this.snake.unregisterSnakeChunk(this)}toString(){return`SnakeChunk ${this.id} of snake ${this.snake.id}`}get offset(){return this.#R}get boundingBox(){return this.#S}get junk(){return this.#P>=this.snake.length}get final(){return this.#x}get shortId(){return 65535&this.id}get clientAge(){return.001*(lt()-this.#A)}get debugInfo(){throw new Error}}class vt{listeners=new Set;_deviceName;constructor(t){this._deviceName=t}addListener(t){this.listeners.add(t)}set(t){this.notifyListeners(t)}notifyListeners(t){this.listeners.forEach((e=>e(t)))}getDeviceName(){return this._deviceName}}const kt=new Set,wt=new class{id;defaultValue;label;#L;#U=!1;#I=[];constructor(t,e,n){this.id=t,this.defaultValue=e,this.label=n;try{const t=window.localStorage.getItem(this.#F);null!==t&&(this.#L=JSON.parse(t),this.#U=!0)}catch(t){console.warn("Failed to load value from local storage.")}}setValue(t){const e=this.#M;this.#U&&e===t||(this.#L=t,this.#U=!0,this.#D(),this.#O(t))}resetValue(){if(!this.#U)return;const t=this.#L;this.#L=null,this.#U=!1,this.#D(),t!==this.defaultValue&&this.#O(this.defaultValue)}subscribe(t){this.#I.push(t),t(this.#M)}get#M(){return this.#U?this.#L:this.defaultValue}#O(t){this.#I.forEach((e=>e(t)))}get#F(){return"settings."+this.id}#D(){const t=this.#F;this.#U?window.localStorage.setItem(t,JSON.stringify(this.#M)):window.localStorage.removeItem(t)}static resetForTests(){kt.clear()}}("input.pointerLock",!1,"Lock pointer");class yt extends vt{clickCatcher=null;lockPointer=!1;constructor(t){super("pointer"),this.pointerDownHandler=this.pointerDownHandler.bind(this),this.pointerUpHandler=this.pointerUpHandler.bind(this),window.addEventListener("pointermove",(e=>{if(null!==this.clickCatcher&&document.pointerLockElement===this.clickCatcher){const n=t().direction;let s=2*Math.cos(n),i=2*Math.sin(n);s+=.01*e.movementX,i-=.01*e.movementY,0===s&&0===i||this.set({direction:Math.atan2(i,s)})}else{const t=e.pageX-.5*window.innerWidth,n=.5*window.innerHeight-e.pageY;if(t*t+n*n>1){const e=Math.atan2(n,t);this.set({direction:e})}}})),wt.subscribe((t=>this.lockPointer=t))}pointerDownHandler(t){t.stopPropagation(),this.lockPointer&&document.pointerLockElement!==this.clickCatcher&&this.clickCatcher?.requestPointerLock(),this.set({wantsFast:!0})}pointerUpHandler(t){t.stopPropagation(),this.set({wantsFast:!1})}setClickCatcher(t){null!==this.clickCatcher&&(this.clickCatcher.removeEventListener("pointerdown",this.pointerDownHandler),this.clickCatcher.removeEventListener("pointerup",this.pointerUpHandler),this.clickCatcher.removeEventListener("pointercancel",this.pointerUpHandler)),t.addEventListener("pointerdown",this.pointerDownHandler),t.addEventListener("pointerup",this.pointerUpHandler),t.addEventListener("pointercancel",this.pointerUpHandler),this.clickCatcher=t}}class Et extends vt{pressed=new Set;keyMappings=new Map;trackedKeys=new Set;stateProvider;previousTickAnyPressed=!1;lastTick=lt();constructor(t){super("keyboard"),this.stateProvider=t,this.addMappings("left",["a","ArrowLeft"]),this.addMappings("right",["d","ArrowRight"]),this.addMappings("fast",["w","ArrowUp","Shift"," "]),window.addEventListener("keydown",(t=>{this.pressed.add(t.key.toLowerCase())})),window.addEventListener("keyup",(t=>{this.pressed.delete(t.key.toLowerCase())})),window.addEventListener("blur",(()=>{this.pressed.clear()}))}addMappings(t,e){const n=this.keyMappings.get(t)??new Set;e.forEach((t=>{const e=t.toLowerCase();n.add(e),this.trackedKeys.add(e)})),this.keyMappings.set(t,n)}tick(){const t=2.5*(lt()-this.lastTick)/1e3;this.lastTick=lt();const e=this.anyPressed();if(!e&&!this.previousTickAnyPressed)return;this.previousTickAnyPressed=e;const n=this.isPressed("fast"),s=this.stateProvider().direction;let i=0;this.isPressed("left")&&(i+=t),this.isPressed("right")&&(i-=t),this.set({wantsFast:n,direction:s+i})}isPressed(t){const e=this.keyMappings.get(t);if(void 0===e)return!1;for(const t of e)if(this.pressed.has(t.toLowerCase()))return!0;return!1}anyPressed(){for(const t of this.pressed)if(this.trackedKeys.has(t))return!0;return!1}}const bt=new Set,Tt=new Set,xt=[];let St,At=!1,Ct=0;function Pt(t){bt.add(t)}function Rt(t){var e;t instanceof Et&&xt.push(t),t.addListener((e=t,t=>{const n=void 0!==t.direction?dt(t.direction):Ct,s=t.wantsFast??At;if(At===s&&Ct===n)return;Ct=n,At=s,bt.forEach((t=>t(s,n)));const i=e.getDeviceName();St!==i&&(St=i,Tt.forEach((t=>t(i))))}))}class Lt{snakeId;#B;#N;#V=!0;#H;constructor(t,e,n){this.snakeId=e,this.#B=t,this.#N=n,this.#H=(t,e)=>{this.alive&&this.#B.sendUserInput(e,t,this.#N.camera.viewBox)},Pt(this.#H),n.events.snakeDeath.addListener((({deadSnakeId:t})=>{var e;t===this.snakeId&&(this.#V=!1,e=this.#H,bt.delete(e))}))}get alive(){return this.#V}}var Ut=0;function It(t,n,s,i,r){var a,o,l={};for(o in n)"ref"==o?a=n[o]:l[o]=n[o];var c={type:t,props:l,key:s,ref:a,__k:null,__:null,__b:0,__e:null,__d:void 0,__c:null,__h:null,constructor:void 0,__v:--Ut,__source:r,__self:i};if("function"==typeof t&&(a=t.defaultProps))for(o in a)void 0===l[o]&&(l[o]=a[o]);return e.vnode&&e.vnode(c),c}class Ft extends f{render(){const t=this.props.options,e=t.buttons??[];return It("div",{class:"dialog-container",children:[It("div",{class:"dialog-shadow"}),It("div",{class:"dialog-modal",children:[t.title?It("div",{class:"dialog-title",children:t.title}):null,It("div",{class:"dialog-content",children:t.content}),It("div",{class:"dialog-buttons",children:e.map((t=>It("button",{onClick:()=>{const e=t.action?t.action():t.value;void 0!==e&&this.props.onExit(e)},children:t.label},t.label)))})]})]})}}const Mt=[],Dt=document.createElement("div");let Ot=null;function Bt(t){return new Promise((e=>{Mt.push({options:{buttons:[{label:"Ok",value:"ok"}],...t},onExit:t=>{Ot=null,e(t),Nt()}}),Nt()}))}function Nt(){if(null!==Ot)return;const t=Mt.shift();L(null,Dt),t?(Ot=t,L(d(Ft,t),Dt),Dt.classList.add("show")):Dt.classList.remove("show")}class Vt{#X=!1;#W=void 0;#Y=void 0;set(){if(this.#X=!0,this.#Y){const t=this.#Y;this.#Y=void 0,this.#W=void 0,t()}}clear(){this.#X=!1}isSet(){return this.#X}wait(t=0){return this.#X?Promise.resolve():(void 0===this.#W&&(this.#W=new Promise((t=>this.#Y=t))),t>0?Promise.race([this.#W,new Promise(((e,n)=>{window.setTimeout(n,t)}))]):this.#W)}}const Ht={alpha:!0,depth:!1,antialias:!0,preserveDrawingBuffer:!1,premultipliedAlpha:!1},Xt=new Vt;let Wt=null;function Yt(){if(!Wt)throw new Error("No WebGL context available");return Wt}async function Gt(){return Xt.isSet()||await Xt.wait(),Yt()}const jt=[];function Kt(t){const e=t.createBuffer();if(null===e)throw new Error("Failed to create buffer.");return e}(async()=>{{const t=await Gt();for(let e=0;e<16;e++)jt.push(Kt(t))}})();const $t=[{snakeBody:[128,191,255],food:[0,128,255]},{snakeBody:[255,184,114],food:[255,134,14]},{snakeBody:[191,255,128],food:[25,255,42]},{snakeBody:[250,255,80],food:[255,255,22]},{snakeBody:[230,67,197],food:[255,0,255]},{snakeBody:[255,81,55],food:[255,25,12]},{snakeBody:[112,111,110],food:[128,182,222]}];function zt(){return $t}const qt=(()=>{const t=zt(),e=new Uint8Array(8*t.length);return t.forEach(((t,n)=>{const s=4*n,i=e.length/2+s;e[s]=t.snakeBody[0],e[s+1]=t.snakeBody[1],e[s+2]=t.snakeBody[2],e[s+3]=255,e[i]=t.food[0],e[i+1]=t.food[1],e[i+2]=t.food[2],e[i+3]=255})),e})();let Jt;function Zt(t,e,n){t.setUniform(e,Qt(n))}function Qt(t){const e=zt();return(t%e.length+.5)/e.length}(async()=>{const t=await Gt();Jt=t.createTexture(),t.bindTexture(t.TEXTURE_2D,Jt),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);const e=t.RGBA;t.texImage2D(t.TEXTURE_2D,0,e,zt().length,2,0,e,t.UNSIGNED_BYTE,qt)})();const te=[[-1,1],[1,1],[-1,-1],[-1,-1],[1,1],[1,-1]];class ee{static FOOD_VERTEX_SIZE=5;id;box;#G;#j=new Float32Array(32*te.length);#K;#o;constructor(t){this.id=t.id,this.box=st.fromTransferable(t.bounds),this.#G=jt.length>0?jt.pop():Kt(Yt()),this.update(t)}update(t){this.#K=t.items.length,this.#j=function(t,e){const n=ee.FOOD_VERTEX_SIZE*te.length,s=t.length*n,i=ee.FOOD_VERTEX_SIZE;(void 0===e||e.length<s)&&(e=new Float32Array(s));for(let s=0;s<t.length;s++){const r=t[s],a=s*n,o=Qt(r.color);for(let t=0;t<te.length;t++){const[n,s]=te[t];e[a+i*t+0]=r.size*n+r.x,e[a+i*t+1]=r.size*s+r.y,e[a+i*t+2]=n,e[a+i*t+3]=s,e[a+i*t+4]=o}}return e}(t.items,this.#j),this.#o=lt()}destroy(){!function(t){jt.length<128&&jt.push(t)}(this.#G)}useBuffer(t){t.bindBuffer(t.ARRAY_BUFFER,this.#G),this.#j&&(t.bufferData(t.ARRAY_BUFFER,this.#j,t.STATIC_DRAW),this.#j=void 0)}isVisible(t,e=0){return st.distance2(this.box,t.viewBox)<=e*e}get numberOfVertices(){return this.#K*te.length}get age(){return.001*(lt()-this.#o)}}class ne{#$=new Map;#z;constructor(t){this.#z=t}add(t,e){const n=this.#$.get(t.id);if(n)n.update(t,e);else{const e=this.#z(t);t.id,e.id,this.#$.set(t.id,e)}}addMultiple(t,e){for(const n of t)this.add(n,e)}get(t){return this.#$.get(t)}has(t){return this.#$.has(t)}runIfPresent(t,e){const n=this.#$.get(t);return n&&e(n),void 0!==n}remove(t){const e=this.#$.get(t);return e&&(this.#$.delete(t),e.destroy&&e.destroy()),e}removeIf(t){const e=[];for(const n of this.#$.values())t(n)&&e.push(n);for(const t of e)t.destroy&&t.destroy(),this.#$.delete(t.id);return e}forEach(t){this.#$.forEach(t)}values(){return this.#$.values()}entries(){return this.#$.entries()}clear(){this.#$.clear()}get size(){return this.#$.size}}class se{#I=new Set;addListener(t){this.#I.add(t)}trigger(t){this.#I.forEach((e=>e(t)))}}class ie{snakes;snakeChunks;foodChunks;events={snakeDeath:new se,gameEnd:new se};camera=new at;statistics={leaderboard:[],numPlayers:0,numBots:0};heatMap;#B;#q;#J=!1;#Z;#Q=0;#tt=!1;constructor(){this.#B=V(new Worker("worker.bundle.js",{name:"SnakeWorker"})),this.snakes=new ne((t=>new mt(t,this.#q))),this.snakeChunks=new ne((t=>{const e=this.snakes.get(t.snakeId);if(void 0===e)throw new Error(`SnakeChunk for unknown snake ${t.snakeId}.`);return new gt(e,t)})),this.foodChunks=new ne((t=>new ee(t))),this.events.snakeDeath.addListener((({deadSnakeId:t,killer:e})=>{t!==this.#Z?e&&e.snakeId===this.#Z&&this.#Q++:this.#Z=void 0}))}static async joinAsPlayer(){const t=await Q,e=new ie,n=e.#B,s=await n.init(t).catch((async t=>(await Bt({title:"Error",content:"Failed to connect to the game server."}),Promise.reject(t))));e.#q=s.config,e.camera.moveTo(et.fromObject(s.startPosition)),e.#Z=s.targetSnakeId,e.heatMap=new Uint8Array(s.config.chunks.rows*s.config.chunks.columns),n.addEventListener("serverUpdate",G((()=>{e.#J=!0}))),n.addEventListener("disconnect",G((()=>{e.#tt=!0,e.events.gameEnd.trigger({reason:"disconnect"})}))),n.onSpectatorChange(G((t=>{const n=t;n.followSnake?e.#Z=n.targetSnakeId:(e.#Z=void 0,e.camera.moveTo(et.fromObject(n.position)))})));const i=new Lt(n,s.targetSnakeId,e);return[e,i]}static joinAsSpectator(){throw new Error("not implemented")}async update(){if(!this.#J)return;const t=await this.#B.getDataChanges();this.#J=t.moreUpdates;const e=t.ticksSinceLastUpdate;t.leaderboard&&(this.statistics=t.leaderboard),t.heatMap&&(this.heatMap=t.heatMap),this.foodChunks.addMultiple(t.foodChunks),this.snakes.addMultiple(t.snakes,e),this.snakeChunks.addMultiple(t.snakeChunks);for(const{deadSnakeId:e,killer:n}of t.snakeDeaths){const t=this.snakes.get(e);if(this.events.snakeDeath.trigger({deadSnakeId:e,killer:n,snake:t}),!t)continue;const s=Array.from(t.getSnakeChunksIterator());for(const t of s)this.snakeChunks.remove(t.id);this.snakes.remove(e)}const n=new Set(t.snakes.map((t=>t.id)));n.size>0&&this.snakes.forEach((t=>{n.has(t.id)||t.pause()})),t.moreUpdates?await this.update():this.#et()}predict(){if(!this.#tt){for(const t of this.snakes.values())t.predict();this.targetSnake&&this.camera.moveToSnake(this.targetSnake)}}quit(){this.#B.quit(),this.#tt=!0}get config(){return this.#q}get targetSnake(){if(void 0!==this.#Z)return this.snakes.get(this.#Z)}get targetSnakeKills(){return this.#Q}#et(){const t=this.camera,e=2*this.#q.snakes.fastSpeed;this.snakeChunks.removeIf((n=>n.junk||!n.couldBeVisible(t,e)&&n.clientAge>1)),this.foodChunks.removeIf((n=>!n.isVisible(t,e)&&n.age>1)),this.snakes.removeIf((n=>n.id!==this.#Z&&!n.hasChunks()&&!n.couldBeVisible(t,e)))}}class re extends f{#nt={current:null};#st;#it;#rt=0;#at=0;#ot;#lt;#ct;constructor(t){super(t),this.#ct=t.maxFPS??60}componentDidMount(){const t=this.#nt.current.getContext("2d",{alpha:!1});this.#st=t,this.#ot=performance.now(),this.#lt=this.#ot,t.fillStyle="black",t.fillRect(0,0,t.canvas.width,t.canvas.height),this.#it=window.requestAnimationFrame(this.#dt.bind(this))}#dt(){const t=performance.now(),e=t-this.#ot,n=t-this.#lt,s=1e3/3;if(e>=s&&(this.#ht(),this.#ot=t-(e-s),this.#rt=0),n>=1e3){const e=this.#at;this.#at=0,this.#lt=t-(n-1e3),this.setState({fps:e})}this.#rt++,this.#at++,this.#it=window.requestAnimationFrame(this.#dt.bind(this))}#ht(){const t=this.#st,e=t.canvas,n=3*this.#rt;if(n>this.#ct){const s=Math.round(e.height*this.#ct/n);t.drawImage(e,0,e.height-s,e.width,s),t.fillStyle="black",t.fillRect(0,0,e.width,e.height-s),this.#ct=n}const s=e.width-2;t.drawImage(e,2,0,s,e.height,0,0,s,e.height),t.fillStyle="black",t.fillRect(e.width-2,e.height,2,e.height);const i=Math.floor(e.height*n/this.#ct);t.fillStyle="white",t.fillRect(e.width-2,e.height-i,2,i)}componentWillUnmount(){window.cancelAnimationFrame(this.#it)}render(){return It("div",{id:"fps-stats",children:[It("canvas",{ref:this.#nt,width:100,height:42}),It("div",{id:"fps-text",children:`FPS: ${this.state.fps??"-"}`})]})}}class ae extends f{render(){const t=this.props.data;if(!t||0===t.leaderboard.length)return null;const e=this.props.targetId;return It("div",{id:"game-stats",children:[It("div",{id:"leaderboard",class:t.leaderboard.length>1?"multiple":"",children:t.leaderboard.map(((t,n)=>It(oe,{data:t,index:n,isTarget:t.id===e},t.name)))}),It("div",{id:"player-numbers",children:[It("div",{children:"Players"}),It("div",{children:t.numPlayers}),It("div",{children:"Bots"}),It("div",{children:t.numBots})]})]})}}function oe(t){const e=t.data,n=t.index,s=t.isTarget?"target":"";return It(u,{children:[It("span",{class:s,children:[n+1,"."]}),It("span",{class:s,children:e.name}),It("span",{class:s,title:"length",children:e.length}),It("span",{class:s,title:"kills",children:0===e.kills?"-":e.kills+"K"})]})}class le extends f{render(){const t=this.props.snake;if(!t)return null;const e=this.props.kills??0;return It("div",{id:"snake-info",children:[It("div",{id:"snake-name",children:t.name}),It("div",{id:"snake-data",children:[It("span",{class:"label",children:"Length:"}),It("span",{class:"value",children:Math.round(t.length)}),e>0?It(u,{children:[It("span",{class:"label",children:"Kills:"}),It("span",{class:"value",children:e})]}):null]})]})}}class ce extends f{#ut;componentDidMount(){this.#ut=window.setInterval((()=>{this.forceUpdate()}),500)}componentWillUnmount(){window.clearInterval(this.#ut)}render(){const t=this.props.game;return It(u,{children:[It(ae,{data:t.statistics,targetId:t.targetSnake?.id}),It(re,{}),It(le,{snake:t.targetSnake,kills:t.targetSnakeKills})]})}}function de(t){return It(u,{children:t.texts.map((t=>{let e=`top:${t.y}px;left:${t.x}px;color:${t.color};`;return t.minWidth&&(e+=`min-width:${t.minWidth};`),t.color&&(e+=`color:${t.color};`),It("div",{class:t.debug?"text debug":"text",style:e,children:t.text},t.key)}))})}let he=null;const ue=[];function fe(t,e,n){ue.push({text:t,key:e,size:12,...n})}class pe{#ft;#pt;#mt=new Map;#_t=new Map;#gt;#vt=0;constructor(t,e,n,s){this.#ft=t;const i=_e(t,t.VERTEX_SHADER,e),r=_e(t,t.FRAGMENT_SHADER,n),a=t.createProgram();if(t.attachShader(a,i),t.attachShader(a,r),t.linkProgram(a),!t.getProgramParameter(a,t.LINK_STATUS))throw new Error("Shader linking failed: "+t.getProgramInfoLog(a));this.#pt=a;const o=t.getProgramParameter(a,t.ACTIVE_ATTRIBUTES),l=[];for(let e=0;e<o;e++){const n=t.getActiveAttrib(a,e),s=t.getAttribLocation(a,n.name);this.#_t.set(n.name,new me(n,s)),l.push(n.name)}this.#gt=void 0!==s?[...s]:l,this.computeStride();const c=t.getProgramParameter(a,t.ACTIVE_UNIFORMS);for(let e=0;e<c;e++){const n=t.getActiveUniform(a,e),s=t.getUniformLocation(a,n.name);this.#mt.set(n.name,new me(n,s))}}computeStride(){const t=Array.from(this.#_t.values()).filter((t=>null===t.value)).reduce(((t,e)=>t+e.size),0);this.#vt=t*Float32Array.BYTES_PER_ELEMENT}use(){this.#ft.useProgram(this.#pt)}run(t,e){const n=this.#ft,{mode:s,start:i,stride:r}=Object.assign({mode:this.#ft.TRIANGLES,start:0,stride:this.#vt},e);let a=0;for(const t of this.#gt){const e=this.#_t.get(t);if(null===e.value)n.enableVertexAttribArray(e.location),n.vertexAttribPointer(e.location,e.size,n.FLOAT,!1,r,a*Float32Array.BYTES_PER_ELEMENT),a+=e.size;else{if(e.type!==n.FLOAT)throw new Error("Constant values for attributes not yet implemented!");n.vertexAttrib1f(e.location,e.value)}}this.#mt.forEach((t=>{if(null!==t.value)if(t.type===n.FLOAT)n.uniform1f(t.location,t.value);else if(t.type===n.SAMPLER_2D)n.uniform1i(t.location,t.value);else if(t.type===n.FLOAT_VEC2)n.uniform2fv(t.location,t.value);else if(t.type===n.FLOAT_VEC3)n.uniform3fv(t.location,t.value);else if(t.type===n.FLOAT_VEC4)n.uniform4fv(t.location,t.value);else if(t.type===n.FLOAT_MAT3)n.uniformMatrix3fv(t.location,!1,t.value);else{if(t.type!==n.FLOAT_MAT4)throw new Error(`Uniform type ${t.type} not implemented.`);n.uniformMatrix4fv(t.location,!1,t.value)}})),n.drawArrays(s,i,t)}get context(){return this.#ft}setAttribute(t,e){const n=this.#_t.get(t);if(void 0===n)throw new Error(`Attribute ${t} does not exist.`);const s=null===n.value!=(null===e);n.value=e,s&&this.computeStride()}setUniform(t,e){const n=this.#mt.get(t);if(void 0===n)throw new Error(`Uniform ${t} does not exist.`);n.value=e}}class me{name;type;location;size;value=null;constructor(t,e){this.name=t.name,this.type=t.type,this.size=ge.get(t.type)*t.size,this.location=e}}function _e(t,e,n){const s=t.createShader(e);if(t.shaderSource(s,n),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS))throw new Error("Shader compile error "+t.getShaderInfoLog(s));return s}const ge=new Map([[WebGLRenderingContext.FLOAT,1],[WebGLRenderingContext.FLOAT_VEC2,2],[WebGLRenderingContext.FLOAT_VEC3,3],[WebGLRenderingContext.FLOAT_VEC4,4],[WebGLRenderingContext.FLOAT_MAT3,9],[WebGLRenderingContext.FLOAT_MAT4,16]]),ve=new Map,ke=new Vt;async function we(t){return await ke.wait(),ve.has(t)?ve.get(t):Promise.reject(new Error(`Shader ${t} not found.`))}async function ye(t,e,n){const s=await we(e+".vert"),i=await we(e+".frag");try{return new pe(t,s,i,n)}catch(t){return console.error(t),await Bt({title:"Error",content:`Failed to compile shader "${e}".`}),Promise.reject(t)}}let Ee,be;(async()=>{const t=await q("shaders.json?h=879eafe6b3",{guard:function(t){if("object"!=typeof t)return!1;for(const[e,n]of Object.entries(t))if("string"!=typeof e||"string"!=typeof n)return!1;return!0}});for(const[e,n]of Object.entries(t))ve.set(e,n);ke.set()})();const Te=function(t){const e=new Float32Array(2*t.length*2);let n=0;for(const[s,i]of t)e[n++]=-s,e[n++]=i,e[n++]=s,e[n++]=i;return e}([[.5,-1],[1,0],[.4,2]]),xe=-.5*Math.PI;let Se,Ae;(async()=>{const t=await Gt();Ee=t.createBuffer(),be=await ye(t,"head"),be.use(),t.bindBuffer(t.ARRAY_BUFFER,Ee),t.bufferData(t.ARRAY_BUFFER,Te,t.STATIC_DRAW)})(),new Float32Array(8),(async()=>{const t=await Gt();Se=await ye(t,"solidcolor"),Ae=t.createBuffer()})();const Ce=new WeakMap,Pe=new WeakMap;let Re,Le;function Ue(){const t=Yt().createBuffer();if(null===t)throw new Error("Failed to create WebGL buffer.");return t}(async()=>{const t=await Gt();Re=await ye(t,"snake",["aPosition","aNormal","aNormalOffset","aRelativePathOffset"])})();const Ie=ee.FOOD_VERTEX_SIZE,Fe=new et(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);(async()=>{const t=await Gt();Le=await ye(t,"food",["aPosition","aLocalPos","aColorIndex"])})();const Me=document.createElement("canvas").getContext("2d");function De(t,e){return Me.font=`sans-serif ${e}px`,Me.measureText(t).width}const Oe=new nt(!0);let Be,Ne,Ve,He,Xe=0,We=!0,Ye=null;const Ge=new Float32Array([0,1,1,1,0,0,1,0]);async function je(t){const e=await Gt();Be.use(),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.bindBuffer(e.ARRAY_BUFFER,Ne),function(t){const{width:e,height:n}=t.canvas,s=2/e,i=2/n;Oe.setEntry(0,0,128*s),Oe.setEntry(1,1,128*i),Oe.setEntry(0,2,1-138*s),Oe.setEntry(1,2,10*i-1)}(e);const n=t.camera.position;!function(t,e){const{columns:n,rows:s}=e.config.chunks;if(Xe=.8*Xe+.2*(We?0:1),Ye===e.heatMap)return;We&&null!==Ye?t.activeTexture(WebGLRenderingContext.TEXTURE3):t.activeTexture(WebGLRenderingContext.TEXTURE2),We?t.bindTexture(t.TEXTURE_2D,He):t.bindTexture(t.TEXTURE_2D,Ve);const i=t.LUMINANCE;t.texImage2D(t.TEXTURE_2D,0,i,n,s,0,i,t.UNSIGNED_BYTE,e.heatMap),null!==Ye&&(We=!We,Xe=We?1:0),Ye=e.heatMap}(e,t),Be.setUniform("uHeatMapTexture1",2),Be.setUniform("uHeatMapTexture2",3),Be.setUniform("uTextureMix",Xe),Be.setUniform("uCameraPosition",function(t,e){const n=t.config.chunks,s=n.columns*n.size,i=n.rows*n.size;return[(.5*s+e.x)/s,(.5*i+e.y)/i]}(t,n)),Be.setUniform("uTransform",Oe.data),Be.run(4,{mode:e.TRIANGLE_STRIP})}function Ke(t){const e=t.createTexture();return t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),e}(async()=>{const t=await Gt();Be=await ye(t,"heatmap"),Ne=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,Ne),t.bufferData(t.ARRAY_BUFFER,Ge.buffer,t.STATIC_DRAW),Ve=Ke(t),He=Ke(t)})();const $e=document.createElement("div"),ze=document.createElement("div"),qe=document.createElement("div");var Je;ze.append(qe),$e.append(ze),$e.id="input-container",ze.id="input-viz-ring",ze.classList.add("hide"),qe.id="input-viz-marker",Pt(((t,e)=>{qe.style.transform=`rotate(${-e}rad)`})),Je=t=>{"keyboard"===t?ze.classList.remove("hide"):ze.classList.add("hide")},Tt.add(Je),document.addEventListener("pointerlockchange",(()=>{null!==document.pointerLockElement?ze.classList.remove("hide"):ze.classList.add("hide")}));const Ze=document.createElement("canvas");Ze.id="mainCanvas",document.body.append(Ze),function(t){const e=t.getContext("webgl",Ht);if(null===e)throw new Error("Failed to create WebGL context.");e.disable(WebGLRenderingContext.DEPTH_TEST),e.enable(WebGLRenderingContext.BLEND),e.pixelStorei(WebGLRenderingContext.UNPACK_ALIGNMENT,1),t.addEventListener("webglcontextlost",(t=>{console.error("WebGL context lost.",t),Bt({title:"Error",content:"The WebGL context has been lost. Reload the page should fix the issue.",buttons:[{label:"Reload",action:()=>window.location.reload()}]})})),Wt=e,Xt.set()}(Ze);const Qe=document.createElement("div");Qe.id="textLayer",document.body.append(Qe),function(t){he=t}(Qe),document.body.append($e);const tn=document.createElement("div");async function en(){const[t,e]=await ie.joinAsPlayer(),n=new Vt;return window.requestAnimationFrame((function n(s){ct(s),t.predict(),function(t){const e=Yt();!function(t){const e=t.canvas,n=e.clientWidth,s=e.clientHeight;e.width===n&&e.height===s||(e.width=n,e.height=s,t.viewport(0,0,n,s))}(e);const n=e.canvas;t.camera.setRatio(n.clientWidth,n.clientHeight),e.clearColor(.1,.1,.1,1),e.clear(e.COLOR_BUFFER_BIT);const s=t.camera.transformMatrix;!function(){const t=Yt(),e=WebGLRenderingContext.TEXTURE0;t.activeTexture(e),t.bindTexture(t.TEXTURE_2D,Jt)}(),function(t,e){const n=Yt(),s=t.targetSnake;Le.use(),n.blendFunc(n.SRC_ALPHA,n.ONE),Le.setUniform("uColorSampler",0),Le.setUniform("uTransform",e.data);const i=s?s.position:Fe;Le.setUniform("uAttractorPosition",[i.x,i.y]);for(const e of t.foodChunks.values())e.isVisible(t.camera)&&(e.useBuffer(n),Le.run(e.numberOfVertices,{stride:Ie*Float32Array.BYTES_PER_ELEMENT}))}(t,s),function(t,e){const n=Yt(),s=t.camera,i=Re;i.use(),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),i.setUniform("uTransform",e.data),i.setUniform("uColorSampler",0);for(const e of t.snakes.values())if(e.hasChunks()){Zt(i,"uSkin",e.skin),i.setUniform("uSnakeFast",e.smoothedFastValue),i.setUniform("uSnakeLength",e.length),i.setUniform("uSnakeMaxWidth",e.width),i.setUniform("uSnakeThinningStart",Math.min(.75,.025*e.length)*e.length);for(const t of e.getSnakeChunksIterator()){if(!t.couldBeVisible(s))continue;i.setUniform("uChunkPathOffset",t.offset);const e=t.gpuData;if(t.final)if(Ce.has(t))n.bindBuffer(n.ARRAY_BUFFER,Ce.get(t));else{const s=Pe.get(t)??Ue();Ce.set(t,s),Pe.delete(t),n.bindBuffer(n.ARRAY_BUFFER,s),n.bufferData(n.ARRAY_BUFFER,e.buffer,n.STATIC_DRAW)}else{const s=Pe.get(t)??Ue();Pe.set(t,s),n.bindBuffer(n.ARRAY_BUFFER,s),n.bufferData(n.ARRAY_BUFFER,e.buffer,n.STREAM_DRAW)}i.run(e.vertices,{mode:n.TRIANGLE_STRIP})}}}(t,s),function(t,e){const n=Yt();be.use(),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),n.bindBuffer(n.ARRAY_BUFFER,Ee),be.setUniform("uTransform",e.data);for(const e of t.snakes.values()){if(!e.hasChunks()||!e.isHeadVisible(t.camera))continue;const{x:s,y:i}=e.position;be.setUniform("uSnakeWidth",1.25*e.width),be.setUniform("uHeadPosition",[s,i]),be.setUniform("uHeadRotation",e.direction+xe),be.setUniform("uSnakeFast",e.smoothedFastValue),Zt(be,"uSkin",e.skin),be.run(Te.length/2,{mode:n.TRIANGLE_STRIP})}}(t,s),function(t){const e=Yt().canvas,n=t.targetSnake;for(const r of t.snakes.values()){if(r===n||!r.hasChunks()||(s=t.camera,i=r.position,!s.viewBox.contains(i)))continue;const a=t.camera.computeScreenCoordinates(r.position,e),o=10+.5*r.width,l=r.name;l&&fe(l,`snake${r.id}`,{color:"white",x:a.x,y:a.y+o,size:12,minWidth:De(l,12)})}var s,i}(t),function(){if(null===he)throw new Error("Text renderer not initialized.");L(d(de,{texts:ue}),he),ue.length=0}(),je(t)}(t),e.alive&&xt.forEach((t=>t.tick())),setTimeout((()=>t.update())),window.requestAnimationFrame(n)})),L(d(ce,{game:t}),tn),window.addEventListener("error",(e=>{t.quit(),console.error("Stopped due to unhandled error.",e)})),t.events.snakeDeath.addListener((async t=>{t.deadSnakeId===e.snakeId&&(document.exitPointerLock(),"try-again"===await Bt({title:"Game over",content:t.killer?`You are dead because you crashed into ${t.killer.name}.`:"You are dead.",buttons:[{label:"Spectate",value:"spectate"},{label:"Try again",value:"try-again"}]})&&n.set())})),t.events.gameEnd.addListener((async t=>{"disconnect"===t.reason&&(await Bt({title:"Disconnected",content:"You have been disconnected from the server.",buttons:[{label:"Try again",value:"try-again"}]}),n.set())})),n.wait()}tn.id="root",document.body.append(tn),function(t){xt.length=0;const e=new yt((()=>({wantsFast:At,direction:Ct})));e.setClickCatcher(t),Rt(e),Rt(new Et((()=>({wantsFast:At,direction:Ct}))))}(tn),Dt.id="dialogLayer",document.body.append(Dt),(async()=>{for(ct(performance.now());;)await en()})()})();